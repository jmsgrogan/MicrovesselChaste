<!DOCTYPE html>
<html>
  <head>

    <title>Scaling DOT to Scala - Soundness | Microvessel Chaste</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

      <!--<link rel="icon" type="image/png" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/favicon.ico">-->
      <!--<link rel="shortcut icon" type="image/png" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/favicon.ico">-->

    <!-- prettify CSS (corresponding js at footer)-->
    <link rel="stylesheet" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/css/prettify.css" type="text/css" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/css/bootstrap.css" type="text/css" />

    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,900,400italic,700italic' rel='stylesheet' type='text/css'>

    <!-- Custom stylesheet -->
    <link rel="stylesheet" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/css/main.css" type="text/css" />

    <!-- Typekit (should stay at top of page, do not move to footer)-->
    <script type="text/javascript" src="//use.typekit.net/abh3wgk.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

    <!-- Atom feeds -->
    <link rel="alternate" type="application/atom+xml" title="News Feed" href="https://jmsgrogan.github.io/MicrovesselChaste/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Feed" href="https://jmsgrogan.github.io/MicrovesselChaste/feed/blog.xml" />


  </head>
  <body>


<div class="darkstrip"></div>

<div class="darkbluetopbar">
  <div class="container" style="height: 100%">
    <div class="navbar-wrap">
      <div class="container" style="position: relative; height: 100%;">
        <div class="scala-logo">
          <a href="https://jmsgrogan.github.io/MicrovesselChaste/index.html"><img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/scala-logo-white-sm.png" alt="white Scala logo" /></a>
        </div>
        <ul class="nav">
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/">Documentation</a></li>
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/installation.html">Download</a></li>
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/community/">Community</a></li>
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/contribute/">Contribute</a></li>
  <li id="source-code" >
    <a href="https://github.com/jmsgrogan/MicrovesselChaste"><img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/github-logo.png" alt="GitHub Logo" /></a>
    <div class="toptip">Source Code</div>
  </li>
  <li id="scala-lang-twitter">
    <a href="https://twitter.com/chaste_project"><img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/twitter-logo-white.png" alt="Twitter Logo" /></a>
    <div class="toptip">Chaste on Twitter</div>
  </li>
</ul>

      </div>
    </div>
  </div>
</div>

<div class="midbluebar">
  <div class="container">
    <h1 id="page-title">Scaling DOT to Scala - Soundness</h1>
  </div>
</div>

<div class="page-container">
  <div class="container" style="min-height: 540px;">
    <!-- <div class="row"> -->
      <!-- <div class="span12"> -->
          <div class="main-page-column">
            <div class="article-date">February 17, 2016</div>
            
              <div class="written">Written By: <span class="by">Martin Odersky</span></div>
            
            <p>In my <a href="http://www.scala-lang.org/blog/2016/02/03/essence-of-scala.html">last
blog post</a>
I introduced DOT, a minimal calculus that underlies much of Scala.
DOT is much more than an academic exercise, because it gives us
guidelines on how to design a sound type system for full Scala.</p>

<h2>Recap: The Problem of Bad Bounds</h2>

<p>As was argued in the previous blog post, the danger a path-dependent type
system like Scala&#39;s faces is inconsistent bounds or aliases. For
instance, you might have a type alias</p>
<div class="highlight"><pre><code class="language-" data-lang="">  type T = String
</code></pre></div>
<p>in scope in some part of the program, but in another part the same
type member <code>T</code> is known as</p>
<div class="highlight"><pre><code class="language-" data-lang="">  type T = Int
</code></pre></div>
<p>If you connect the two parts, you end up allowing assigning a <code>String</code>
to an <code>Int</code> and vice versa, which is unsound - it will crash at
runtime with a <code>ClassCastException</code>. The problem is that there
is no obvious, practical, compile time analysis for DOT or
Scala that ensures that all types have good bounds. Types can contain
abstract type members with bounds that can be refined elsewhere and
several independent refinements might lead together to a bad bound
problem.  Barring a whole program analysis there is no specific
point in the program where we can figure this out straightforwardly.</p>

<p>In DOT, the problem is resolved by insisting that every path prefix <code>p</code>
of a type <code>p.T</code> is at runtime a concrete value. That way, we only have
to check for good bounds when objects are <em>created</em> with <code>new</code>, and
that check is easy: When objects are created, we know their class and
we can insist that all nested types in that class are aliases or
have consistent bounds. So far so good.</p>

<h2>Loopholes Caused by Scaling Up</h2>

<p>But if we want to scale up the DOT result for full Scala, several
loopholes open up. These come all down to the fact that the prefix of
a type selection might <em>not</em> be a value that&#39;s constructed with a
<code>new</code> at run time.  The loopholes can be classified into three
categories:</p>

<ol>
<li><p>The prefix value might be lazy, and never instantiated to anything, as in:</p>
<div class="highlight"><pre><code class="language-" data-lang="">lazy val p: S = p
... p.T ...
</code></pre></div>
<p>Note that trying to access the lazy value <code>p</code> would result in an infinite loop. But using <code>p</code> in a type does not force its evaluation, so we might never evaluate <code>p</code>. Since <code>p</code> is not initialized with a <code>new</code>, bad bounds for <code>T</code> would go undetected.</p></li>
<li><p>The prefix value might be initialized to <code>null</code>, as in</p>
<div class="highlight"><pre><code class="language-" data-lang="">val p: S = null
... p.T ...
</code></pre></div>
<p>The problem here is similar to the first one. <code>p</code> is not initialized
with a <code>new</code> so we know nothing about the bounds of <code>T</code>.</p></li>
<li><p>The prefix might be a type <code>T</code> in a type projection <code>T # A</code>, where <code>T</code>
is not associated with a runtime value.</p></li>
</ol>

<p>We can in fact construct soundness issues in all of these cases. Look
at the discussion for issues <a href="https://github.com/lampepfl/dotty/issues/50">#50</a>
and <a href="https://github.com/lampepfl/dotty/issues/1050">#1050</a> in the
<a href="https://github.com/lampepfl/dotty/issues/1050">dotty</a> repository
on GitHub. All issues work fundamentally in the same way: Construct a type <code>S</code>
which has a type member <code>T</code> with bad bounds, say</p>
<div class="highlight"><pre><code class="language-" data-lang="">Any &lt;: T &lt;: Nothing
</code></pre></div>
<p>Then, use the left subtyping to turn an expression of type <code>Any</code> into
an expression of type <code>T</code> and use the right subtyping to turn that
expression into an expression of type <code>Nothing</code>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">def f(x: Any): p.T = x
def g(x: p.T): Nothing = x
</code></pre></div>
<p>Taken together, <code>g(f(x))</code> will convert every expression into an
expression of type <code>Nothing</code>. Since <code>Nothing</code> is a subtype of every
other type, this means you can convert an arbitrary expression to have
any type you choose. Such a feat is an impossible promise, of
course. The promise is usually broken at run-time by failing with a
<code>ClassCastException</code>.</p>

<h2>Plugging the Loopholes</h2>

<p>To get back to soundness we need to plug the loopholes. Some of the
necessary measures are taken in pull request <a href="https://github.com/lampepfl/dotty/issues/1051">#1051</a>.
That pull request</p>

<ul>
<li>tightens the rules for overrides of lazy values: lazy values
cannot override or implement non-lazy values,</li>
<li>tightens the rules which lazy values can appear in paths: they
must be final and must have concrete types with known consistent bounds,</li>
<li>allows type projections <code>T # A</code> only if <code>T</code> is a concrete type
with known consistent bounds.</li>
</ul>

<p>It looks like this is sufficient to plug soundness problems (1) and
(3). To plug (2), we need to make the type system track nullability in
more detail than we do it now. Nullability tracking is a nice feature
in its own right, but now we have an added incentive for implementing
it: it would help to ensure type soundness.</p>

<p>There&#39;s one sub-case of nullability checking which is much harder to do
than the others. An object reference <code>x.f</code> might be <code>null</code> at run time
because the field <code>f</code> is not yet initialized. This can lead to a
soundness problem, but in a more roundabout way than the other issues
we have identified. In fact, Scala guarantees that in a program that
runs to completion without aborting, every field will eventually be
initialized, so every non-null field will have good bounds. Therefore,
the only way an initialized field <code>f</code> could cause a soundness problem
is if the program in question would never get to initialize <code>f</code>,
either because it goes into an infinite loop or because it aborts with
an exception or <code>System.exit</code> call before reaching the initialization
point of <code>f</code>. It&#39;s a valid question whether type soundness guarantees
should extend to this class of &quot;strange&quot; programs. We might want to
draw the line here and resort to runtime checks or exclude &quot;strange&quot;
programs from any soundness guarantees we can give. The research community
has coined the term <a href="http://soundiness.org/">soundiness</a> for
this kind of approach and has <a href="http://cacm.acm.org/magazines/2015/2/182650-in-defense-of-soundiness/fulltext">advocated</a> for it.</p>

<p>The necessary restrictions on type projection <code>T # A</code> are problematic
because they invalidate some idioms in type-level programming. For
instance, the cute trick of making Scala&#39;s type system Turing complete
by having it <a href="https://michid.wordpress.com/2010/01/29/scala-type-level-encoding-of-the-ski-calculus/">simulate SK
combinators</a>
would no longer work since that one relies on unrestricted type
projections. The same holds for some of the encodings of type-level
arithmetic.</p>

<p>To ease the transition, we will continue for a while to allow unrestricted type
projections under a flag, even though they are potentially
unsound. In the current dotty compiler, that flag is a language import
<code>-language:Scala2</code>, but it could be something different for other
compilers, e.g. <code>-unsafe</code>.  Maybe we can find rules that are less
restrictive than the ones we have now, and are still sound.  But one
aspect should be non-negotiable: Any fundamental deviations from the
principles laid down by DOT needs to be proven mechanically correct
just like DOT was. We have achieved a lot with the DOT proofs, so we
should make sure not to back-slide. And if the experience of the past
10 years has taught us one thing, it is that the meta theory of type
systems has many more surprises in store than one might think. That&#39;s
why mechanical proofs are essential.</p>

            
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  
    var disqus_shortname = 'scalasip'; // required: replace example with your forum shortname
  

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          <div class="sidebar">
            <div class="sidebar-inner">
              <div id="toc"></div>
            </div>
          </div>
          <div style="clear:both"></div>
      <!-- </div> -->
    <!-- </div> -->
  </div>
</div>


  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Documentation</h5></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/getting-started.html">Getting Started</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/python-api/index.html">Python API</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/cpp-api/index.html">C++ API</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/tutorials.html">Tutorials</a></li>
    </ul>
    <ul>
      <li><h5>Download</h5></li>
        <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/installation.html">Instructions</a></li>
    </ul>
    <ul>
      <li><h5>Community</h5></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/community/">Community</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/community/index.html#mailing-lists">Mailing Lists</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/contribute">How to Help</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/contribute/">Report an Issue</a></li>
    </ul>
    </div>
    <div class="container">
      <div class="copyright">
        <p style="float: left;"><br/>Copyright &copy; 2015-<span class="current-year"></span> University of Oxford<br/> Oxford, United Kingdom. Released under <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.<br />
Source code for this website was modified from the <a href="https://www.scala-lang.org/">scala website</a> on <a href="https://www.scala-lang.org/">github</a>. <br />
See <a href="https://raw.github.com/scala/scala-lang/master/license.md">original license</a> for details. </p>
      </div>
      <div class="scala-logo-footer">
        <img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/mvc_logo_25.png" alt="Microvessel Chaste Logo" />
      </div>
    </div> <!-- container -->
    </div> <!-- footer -->

    <!-- prettify  js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/prettify/prettify.js" type="text/javascript" ></script>
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/prettify/lang-scala.js" type="text/javascript" ></script>

    <!-- jquery js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/jquery-1.8.3.min.js" type="text/javascript" ></script>
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/jquery.stellar.min.js" type="text/javascript" ></script>
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/tweetMachine.min.js" type="text/javascript" ></script>

    <!-- modernizr js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js" type="text/javascript" ></script>

    <!-- retina js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/retina.js" type="text/javascript" ></script>

    <!-- backstretch js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/jquery.backstretch.min.js" type="text/javascript" ></script>

    <!-- Bootstrap JS -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/bootstrap.min.js" type="text/javascript" ></script>

    
    <!-- table of contents JS -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/toc.js" type="text/javascript" ></script>
    <script type="text/javascript">
      $(document).ready(function(){
        $('#toc').toc({exclude: 'h1, h5, h6', context: '', autoId: true, numerate: false});
        function moveScroller() {
          if ($(".sidebar").length == 0)
            return;
          var a = function() {
            var topOfScroll = $(window).scrollTop();
            var topOfSidebar = $(".sidebar").offset().top;
            var sidebarInner = $(".sidebar-inner");
            var bottomOfSidebarInner = $(".sidebar-inner").offset().top + $(".sidebar-inner").outerHeight();
            var topOfFooter = $(".footer").offset().top - 10;
            var footerHeight = $(".footer").outerHeight();
            if (topOfScroll > topOfSidebar) {
              if (bottomOfSidebarInner > topOfFooter) {
                sidebarInner.css({position:"fixed",bottom:footerHeight,top:""});
              } else {
                sidebarInner.css({position:"fixed",top:"10px",bottom:""});
              }
            } else {
              sidebarInner.css({position:"relative",top:""});
            }
          };
          $(window).scroll(a);a()
        }
        moveScroller();
      })
    </script>
    

    <!-- Custom javascript -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/main.js" type="text/javascript"></script>
  </body>
</html>

