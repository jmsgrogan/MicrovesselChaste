<!DOCTYPE html>
<html>
  <head>

    <title>Multiversal Equality for Scala | Microvessel Chaste</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

      <!--<link rel="icon" type="image/png" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/favicon.ico">-->
      <!--<link rel="shortcut icon" type="image/png" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/favicon.ico">-->

    <!-- prettify CSS (corresponding js at footer)-->
    <link rel="stylesheet" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/css/prettify.css" type="text/css" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/css/bootstrap.css" type="text/css" />

    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,900,400italic,700italic' rel='stylesheet' type='text/css'>

    <!-- Custom stylesheet -->
    <link rel="stylesheet" href="https://jmsgrogan.github.io/MicrovesselChaste/resources/css/main.css" type="text/css" />

    <!-- Typekit (should stay at top of page, do not move to footer)-->
    <script type="text/javascript" src="//use.typekit.net/abh3wgk.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

    <!-- Atom feeds -->
    <link rel="alternate" type="application/atom+xml" title="News Feed" href="https://jmsgrogan.github.io/MicrovesselChaste/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Feed" href="https://jmsgrogan.github.io/MicrovesselChaste/feed/blog.xml" />


  </head>
  <body>


<div class="darkstrip"></div>

<div class="darkbluetopbar">
  <div class="container" style="height: 100%">
    <div class="navbar-wrap">
      <div class="container" style="position: relative; height: 100%;">
        <div class="scala-logo">
          <a href="https://jmsgrogan.github.io/MicrovesselChaste/index.html"><img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/scala-logo-white-sm.png" alt="white Scala logo" /></a>
        </div>
        <ul class="nav">
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/">Documentation</a></li>
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/installation.html">Download</a></li>
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/community/">Community</a></li>
  <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/contribute/">Contribute</a></li>
  <li id="source-code" >
    <a href="https://github.com/jmsgrogan/MicrovesselChaste"><img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/github-logo.png" alt="GitHub Logo" /></a>
    <div class="toptip">Source Code</div>
  </li>
  <li id="scala-lang-twitter">
    <a href="https://twitter.com/chaste_project"><img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/twitter-logo-white.png" alt="Twitter Logo" /></a>
    <div class="toptip">Chaste on Twitter</div>
  </li>
</ul>

      </div>
    </div>
  </div>
</div>

<div class="midbluebar">
  <div class="container">
    <h1 id="page-title">Multiversal Equality for Scala</h1>
  </div>
</div>

<div class="page-container">
  <div class="container" style="min-height: 540px;">
    <!-- <div class="row"> -->
      <!-- <div class="span12"> -->
          <div class="main-page-column">
            <div class="article-date">May 6, 2016</div>
            
              <div class="written">Written By: <span class="by">Martin Odersky</span></div>
            
            <p>I have been working recently on making equality tests using <code>==</code> and
<code>!=</code> safer in Scala. This has led to a <a href="https://github.com/lampepfl/dotty/issues/1247">Language Enhancement
Proposal</a> which I summarize in this blog.</p>

<h2>Why Change Equality?</h2>

<p>Scala prides itself of its strong static type system. Its type discipline is particularly useful when it comes to refactoring. Indeed, it&#39;s possible to write programs in such a way that refactoring problems show up with very high probability as type errors. This is essential for being able to refactor with the confidence that nothing will break. And the ability to do such refactorings is in turn very important for keeping code bases from rotting.</p>

<p>Of course, getting such a robust code base requires the cooperation of the developers. They should avoid type <code>Any</code>, casts, <a href="http://c2.com/cgi/wiki?StringlyTyped">stringly typed</a> logic, and more generally any operation over loose types that do not capture the important properties of a value. Unfortunately, there is one area in Scala where such loose types are very hard to avoid: That&#39;s equality. Comparisons with <code>==</code> and <code>!=</code> are <em>universal</em>. They compare any two values, no matter what their types are. This causes real problems for writing code and more problems for refactoring it.</p>

<p>For instance, one might want to introduce a proxy for some data structure so that instead of accessing the data structure directly one goes through the proxy. The proxy and the underlying data would have different types. Normally this should be an easy refactoring. If one passes by accident a proxy for the underlying type or <em>vice versa</em> the type checker will flag the error. However, if one accidentally compares a proxy with the underlying type using <code>==</code> or a pattern match, the program is still valid, but will just always say <code>false</code>. This is a real worry in practice. I recently abandoned a desirable extensive refactoring because I feared that it would be too hard to track down such errors.</p>

<h2>Where Are We Today?</h2>

<p>The problems of universal equality in Scala are of course well
known. Some libraries have tried to fix it by adding another equality
operator with more restricted typing. Most often this safer equality
is written <code>===</code>. While <code>===</code> is certainly useful, I am not a fan of
adding another equality operator to the language and core
libraries. It would be much better if we could fix <code>==</code> instead. This
would be both simpler and would catch all potential equality problems
including those related to pattern matching.</p>

<p>How can <code>==</code> be fixed? It looks much harder to do this than adding an
alternate equality operator. First, we have to keep backwards
compatibility. The ability to compare everything to everything is by
now baked into lots of code and libraries.
Second, with just one equality operator
we need to make this operator work in all cases where it makes
sense. An alternative <code>===</code> operator can choose to refuse some
comparisons that should be valid because there&#39;s always <code>==</code>
to fall back to. With a unique <code>==</code> operator we do not have this
luxury.</p>

<p>The current status in Scala is that the compiler will give warnings
for <em>some</em> comparisons that are always <code>false</code>. But the coverage is
weak. For instance this will give a warning:</p>
<div class="highlight"><pre><code class="language-" data-lang="">scala&gt; 1 == "abc"
&lt;console&gt;:12: warning: comparing values of types Int and String using `==' will always yield false
</code></pre></div>
<p>But this will not:</p>
<div class="highlight"><pre><code class="language-" data-lang="">scala&gt; "abc" == 1
res2: Boolean = false
</code></pre></div>
<p>There are also cases where a warning is given for a valid equality
test that actually makes sense because the result could be <code>true</code>. In
summary, the current checking catches some obvious bugs, which is
nice. But it is far too weak and fickle to be an effective refactoring
aid.</p>

<h2>What&#39;s Proposed?</h2>

<p>I believe to do better, we need to enlist the cooperation of
developers. Ultimately it&#39;s the developer who provides implementations
of equality methods and who is therefore best placed to characterize
which equalities make sense. Sometimes this characterization can be
involved. For instance, an <code>Int</code> can be compared to other primitive
numeric values or to instances of type <code>java.lang.Number</code> but any other
comparison will always yield <code>false</code>. Or, it makes sense to compare
two <code>Option</code> values if and only if it makes sense to compare the optional
element values.</p>

<p>The best known way to characterize such relationships is with type
classes. Implicit values of a trait <code>Eq[T, U]</code> can capture the
property that values of type <code>T</code> can be compared to values of type
<code>U</code>. Here&#39;s the definition of <code>Eq</code></p>
<div class="highlight"><pre><code class="language-" data-lang="">package scala

trait Eq[-T, -U]
</code></pre></div>
<p>That is, <code>Eq</code> is a pure marker trait with two type parameters and without
any members.  Developers can define equality classes by giving
implicit <code>Eq</code> instances. Here is a simple one:</p>
<div class="highlight"><pre><code class="language-" data-lang="">   implicit def eqString: Eq[String, String] = Eq
</code></pre></div>
<p>This states that strings can be only compared to strings, not to values of other types.
Here&#39;s a more complicated <code>Eq</code> instance:</p>
<div class="highlight"><pre><code class="language-" data-lang="">  implicit def eqOption[T, U](implicit _eq: Eq[T, U]): Eq[Option[T], Option[U]] = Eq
</code></pre></div>
<p>This states that <code>Option</code> values can be compared if their elements can be compared.</p>

<p>It&#39;s foreseen that such <code>Eq</code> instances can be generated automatically. If we add
an annotation <code>@equalityClass</code> to <code>Option</code> like this</p>
<div class="highlight"><pre><code class="language-" data-lang="">  @equalityClass class Option[+T] { ... }
</code></pre></div>
<p>then the <code>eqOption</code> definition above would be generated automatically in <code>Option</code>&#39;s companion object.</p>

<p>Given a set of <code>Eq</code> instances, the idea is that the Scala
compiler will check every time it encounters a <em>potentially
problematic</em> comparison between values of types <code>T</code> and <code>U</code> that there
is an implicit instance of <code>Eq[T, U]</code>. A comparison is <em>potentially
problematic</em> if it is between incompatible types. As long as <code>T &lt;: U</code>
or <code>U &lt;: T</code> the equality could make sense because both sides can
potentially be the same value.</p>

<p>So this means we still keep universal equality as it is in Scala now
- we don&#39;t have a choice here anyway, because of backwards
compatibility. But we render it safe by checking that for each
comparison the corresponding <code>Eq</code> instance exists.</p>

<p>What about types for which no <code>Eq</code> instance exists? To maintain
backwards compatibility, we allow comparisons of such types as well,
by means of a fall-back <code>eqAny</code> instance. But we do not allow comparisons
between types that have an <code>Eq</code> instance and types that have none.
Details are explained in the
<a href="https://github.com/lampepfl/dotty/issues/1247">proposal</a>.</p>

<h2>Properties</h2>

<p>Here are some nice properties of the proposal</p>

<ol>
<li>It is <em>opt-in</em>. To get safe checking, developers have to annotate with <code>@equalityClass</code> classes that should
 allow comparisons only between their instances, or they have to define implicit
<code>Eq</code> instances by hand.</li>
<li>It is backwards compatible. Without developer-provided <code>Eq</code> instances, equality works as before.</li>
<li>It carries no run-time cost compared to universal equality. Indeed the run-time behavior of
 equality is not affected at all.</li>
<li>It has no problems with parametricity, variance, or bottom types.</li>
<li>Depending on the actual <code>Eq</code> instances given, it can be very precise. That is,
 no comparisons that might yield <code>true</code> need to be rejected, and most comparisons that
will always yield <code>false</code> are in fact rejected.</li>
</ol>

<p>The scheme effectively leads to a partition of the former universe of
types into sets of types. Values with types in the same partition can
be compared among themselves but values with types in different
partitions cannot.
An <code>@equalityClass</code> annotation on a type creates a new partition. All
types that do not have any <code>Eq</code> instances (except <code>eqAny</code>, that is)
form together another partition.
So instead of a single <em>universe</em> of values that can be compared to
each other we get a <em>multiverse</em> of partitions. Hence the name of the
proposal: <strong>Multiversal Equality</strong>.</p>

            
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  
    var disqus_shortname = 'scalasip'; // required: replace example with your forum shortname
  

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          <div class="sidebar">
            <div class="sidebar-inner">
              <div id="toc"></div>
            </div>
          </div>
          <div style="clear:both"></div>
      <!-- </div> -->
    <!-- </div> -->
  </div>
</div>


  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Documentation</h5></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/getting-started.html">Getting Started</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/python-api/index.html">Python API</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/cpp-api/index.html">C++ API</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/tutorials.html">Tutorials</a></li>
    </ul>
    <ul>
      <li><h5>Download</h5></li>
        <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/documentation/installation.html">Instructions</a></li>
    </ul>
    <ul>
      <li><h5>Community</h5></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/community/">Community</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/community/index.html#mailing-lists">Mailing Lists</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/contribute">How to Help</a></li>
      <li><a href="https://jmsgrogan.github.io/MicrovesselChaste/contribute/">Report an Issue</a></li>
    </ul>
    </div>
    <div class="container">
      <div class="copyright">
        <p style="float: left;"><br/>Copyright &copy; 2015-<span class="current-year"></span> University of Oxford<br/> Oxford, United Kingdom. Released under <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.<br />
Source code for this website was modified from the <a href="https://www.scala-lang.org/">scala website</a> on <a href="https://www.scala-lang.org/">github</a>. <br />
See <a href="https://raw.github.com/scala/scala-lang/master/license.md">original license</a> for details. </p>
      </div>
      <div class="scala-logo-footer">
        <img src="https://jmsgrogan.github.io/MicrovesselChaste/resources/img/mvc_logo_25.png" alt="Microvessel Chaste Logo" />
      </div>
    </div> <!-- container -->
    </div> <!-- footer -->

    <!-- prettify  js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/prettify/prettify.js" type="text/javascript" ></script>
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/prettify/lang-scala.js" type="text/javascript" ></script>

    <!-- jquery js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/jquery-1.8.3.min.js" type="text/javascript" ></script>
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/jquery.stellar.min.js" type="text/javascript" ></script>
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/tweetMachine.min.js" type="text/javascript" ></script>

    <!-- modernizr js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js" type="text/javascript" ></script>

    <!-- retina js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/retina.js" type="text/javascript" ></script>

    <!-- backstretch js -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/jquery.backstretch.min.js" type="text/javascript" ></script>

    <!-- Bootstrap JS -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/bootstrap.min.js" type="text/javascript" ></script>

    
    <!-- table of contents JS -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/vendor/toc.js" type="text/javascript" ></script>
    <script type="text/javascript">
      $(document).ready(function(){
        $('#toc').toc({exclude: 'h1, h5, h6', context: '', autoId: true, numerate: false});
        function moveScroller() {
          if ($(".sidebar").length == 0)
            return;
          var a = function() {
            var topOfScroll = $(window).scrollTop();
            var topOfSidebar = $(".sidebar").offset().top;
            var sidebarInner = $(".sidebar-inner");
            var bottomOfSidebarInner = $(".sidebar-inner").offset().top + $(".sidebar-inner").outerHeight();
            var topOfFooter = $(".footer").offset().top - 10;
            var footerHeight = $(".footer").outerHeight();
            if (topOfScroll > topOfSidebar) {
              if (bottomOfSidebarInner > topOfFooter) {
                sidebarInner.css({position:"fixed",bottom:footerHeight,top:""});
              } else {
                sidebarInner.css({position:"fixed",top:"10px",bottom:""});
              }
            } else {
              sidebarInner.css({position:"relative",top:""});
            }
          };
          $(window).scroll(a);a()
        }
        moveScroller();
      })
    </script>
    

    <!-- Custom javascript -->
    <script src="https://jmsgrogan.github.io/MicrovesselChaste/resources/js/main.js" type="text/javascript"></script>
  </body>
</html>

